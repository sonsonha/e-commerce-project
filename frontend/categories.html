<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n L√Ω Lo·∫°i S·∫£n Ph·∫©m</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet"/>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>

  <style>
    :root {
      --bs-primary: #ff7f50;
    }
    body { background: #f4f4f4; }
    .table-responsive { margin-top: 1rem; }
    .modal-header { background: var(--bs-primary); color: #fff; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #ff7f50;">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">E-Commerce</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="http://127.0.0.1:5500/frontend/sign-up.html">Sign Up</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="http://127.0.0.1:5500/frontend/manage-user.html">Manage Users</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="http://127.0.0.1:5500/frontend/variant.html">Manage Variants</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container py-4">
    <h1 class="text-center mb-4" style="color: var(--bs-primary)">üõí Qu·∫£n L√Ω Lo·∫°i S·∫£n Ph·∫©m</h1>
    <div class="table-responsive">
      <table id="catTable" class="table table-striped table-bordered w-100">
        <thead class="table-primary">
          <tr>
            <th>ID</th><th>T√™n lo·∫°i</th><th>M√¥ t·∫£</th><th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- N√∫t Th√™m Lo·∫°i -->
    <button id="addBtn" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#categoryModal">
      Th√™m Lo·∫°i
    </button>
  </div>

  <!-- Modal Th√™m/S·ª≠a -->
  <div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Th√™m / C·∫≠p nh·∫≠t Lo·∫°i</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="catForm" class="p-3 needs-validation" novalidate>
          <input type="hidden" id="catID"/>
          <div class="mb-3">
            <label class="form-label">T√™n lo·∫°i</label>
            <input type="text" class="form-control" id="catName" required/>
            <div class="invalid-feedback">Vui l√≤ng nh·∫≠p t√™n lo·∫°i.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">M√¥ t·∫£</label>
            <textarea class="form-control" id="catDesc"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">L∆∞u</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Th√¥ng B√°o Th√†nh C√¥ng -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="successModalLabel">Th√†nh c√¥ng!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="successMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: jQuery, Bootstrap, DataTables, SweetAlert2 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    let table;
    function loadTable() {
      $.get('http://localhost:3000/api/categories/')
        .done(data => {
          table.clear();
          data.forEach(cat => {
            table.row.add([  
              cat.CategoryID,
              cat.CategoryName,
              cat.Description,
              `<button class="btn btn-warning btn-sm me-1 editBtn" data-id="${cat.CategoryID}">S·ª≠a</button>
               <button class="btn btn-danger btn-sm delBtn" data-id="${cat.CategoryID}">X√≥a</button>` 
            ]);
          });
          table.draw();
        })
        .fail(() => alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu!'));
    }

    $(document).ready(function() {
      // Kh·ªüi t·∫°o DataTable
      table = $('#catTable').DataTable({
        columns: [
          { title: "ID" },
          { title: "T√™n lo·∫°i" },
          { title: "M√¥ t·∫£" },
          { title: "H√†nh ƒë·ªông", orderable: false }
        ],
        language: {
          search: "T√¨m ki·∫øm:",
          lengthMenu: "Hi·ªán _MENU_ b·∫£n ghi"
        }
      });
      loadTable();

      // N√∫t Th√™m
      $('#addBtn').click(() => {
        $('#catForm')[0].reset();
        $('#catID').val('');
      });

      // N√∫t S·ª≠a
      $('#catTable tbody').on('click', '.editBtn', function() {
        const id = $(this).data('id');
        $.get(`http://localhost:3000/api/categories/${id}`)
          .done(cat => {
            $('#catID').val(cat.CategoryID);
            $('#catName').val(cat.CategoryName);
            $('#catDesc').val(cat.Description);
            new bootstrap.Modal($('#categoryModal')).show();
          })
          .fail(() => alert('L·ªói khi l·∫•y th√¥ng tin lo·∫°i.'));
      });

      // N√∫t X√≥a
      $('#catTable tbody').on('click', '.delBtn', function() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) return;
        const id = $(this).data('id');
        $.ajax({
          url: 'http://localhost:3000/api/categories/delete',
          method: 'DELETE',
          contentType: 'application/json',
          data: JSON.stringify({ categoryID: id })
        })
        .done(() => {
          loadTable();
          $('#successMessage').text('X√≥a lo·∫°i s·∫£n ph·∫©m th√†nh c√¥ng!');
          new bootstrap.Modal($('#successModal')).show();
        })
        .fail(xhr => alert(xhr.responseJSON.message || 'L·ªói khi x√≥a.'));
      });

      // Submit form Th√™m/S·ª≠a
      $('#catForm').on('submit', function(e) {
        e.preventDefault();
        if (!this.checkValidity()) return $(this).addClass('was-validated');
        const id = $('#catID').val();
        const payload = {
          categoryName: $('#catName').val(),
          description: $('#catDesc').val()
        };
        let url = 'http://localhost:3000/api/categories/create', method = 'POST';
        if (id) {
          url = 'http://localhost:3000/api/categories/update';
          method = 'PUT';
          payload.categoryID = +id;
        }
        $.ajax({
          url, method,
          contentType: 'application/json',
          data: JSON.stringify(payload)
        })
        .done(() => {
          $('#categoryModal').modal('hide');
          loadTable();
          $('#successMessage').text('L∆∞u lo·∫°i s·∫£n ph·∫©m th√†nh c√¥ng!');
          new bootstrap.Modal($('#successModal')).show();
        })
        .fail(xhr => alert(xhr.responseJSON.message || 'L·ªói khi l∆∞u.'));
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n L√Ω Bi·∫øn Th·ªÉ</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet"/>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    :root { --bs-primary: #ff7f50; }
    body { background: #f4f4f4; }
    .table-responsive { margin-top: 1rem; }
    .modal-header { background: var(--bs-primary); color: #fff; }
    .filter-section { margin-bottom: 20px; }
  </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #ff7f50;">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">E-Commerce</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="http://127.0.0.1:5500/frontend/sign-up.html">Sign Up</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="http://127.0.0.1:5500/frontend/manage-user.html">Manage Users</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="http://127.0.0.1:5500/frontend/variant.html">Manage Variants</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
  <div class="container py-4">
    <h1 class="text-center mb-4" style="color: var(--bs-primary)">üõí Qu·∫£n L√Ω Bi·∫øn Th·ªÉ</h1>

    <!-- L·ªçc theo t√™n s·∫£n ph·∫©m -->
    <div class="filter-section">
      <label for="productNameFilter">T√™n S·∫£n Ph·∫©m: </label>
      <input id="productNameFilter" type="text" class="form-control d-inline-block w-50" placeholder="T√¨m s·∫£n ph·∫©m..." />
      <button id="filterProduct" class="btn btn-primary ms-2">L·ªçc</button>
    </div>

    <!-- L·ªçc theo gi√° -->
    <div class="filter-section">
      <label for="priceMin">Gi√° t·ª´: </label>
      <input id="priceMin" type="number" class="form-control d-inline-block w-25" placeholder="T·ª´" />
      <label for="priceMax" class="ms-2">ƒê·∫øn: </label>
      <input id="priceMax" type="number" class="form-control d-inline-block w-25" placeholder="ƒê·∫øn" />
      <button id="filterPrice" class="btn btn-primary ms-2">L·ªçc</button>
    </div>

    <div class="table-responsive">
      <button id="addVariantBtn" class="btn btn-success mb-3">Th√™m Bi·∫øn Th·ªÉ</button>
      <table id="variantTable" class="table table-striped table-bordered w-100">
        <thead class="table-primary">
          <tr>
            <th>VariantID</th><th>ProductID</th><th>ProductName</th><th>Name</th><th>Price</th><th>StockQuantity</th><th>Attribute</th><th>Value</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal C·∫≠p nh·∫≠t -->
<!-- Modal C·∫≠p nh·∫≠t Bi·∫øn Th·ªÉ -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5>C·∫≠p Nh·∫≠t Bi·∫øn Th·ªÉ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="updateForm" class="p-3">
          <input type="hidden" id="editVariantID" />
          <div class="mb-3">
            <label class="form-label">Product</label>
            <select id="editProductID" class="form-select" required>
              <!-- Options dynamically populated -->
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input id="editName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Price</label>
            <input id="editPrice" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Quantity</label>
            <input id="editStockQuantity" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Attribute</label>
            <input id="editAttribute" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Value</label>
            <input id="editValue" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Save Changes</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Th√™m Bi·∫øn Th·ªÉ -->
  <div class="modal fade" id="addVariantModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5>Th√™m Bi·∫øn Th·ªÉ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addVariantForm" class="p-3">
          <div class="mb-3">
            <label class="form-label">ProductID</label>
            <select id="addProductID" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input id="addName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Price</label>
            <input id="addPrice" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Quantity</label>
            <input id="addStockQuantity" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Attribute</label>
            <input id="addAttribute" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Value</label>
            <input id="addValue" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Add Variant</button>
        </form>
      </div>
    </div>
  </div>

  <!-- JS: jQuery, Bootstrap, DataTables, SweetAlert2 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API = 'http://localhost:3000/api/variants';

    // L·∫•y danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o select
    // async function fetchProducts() {
    //   try {
    //     const res = await $.ajax({
    //       url: 'http://localhost:3000/api/products', // ƒê·∫£m b·∫£o API n√†y tr·∫£ v·ªÅ danh s√°ch s·∫£n ph·∫©m
    //       method: 'GET',
    //       success: function(response) {
    //         const productSelect = $('#editProductID, #addProductID');
    //         productSelect.empty();
    //         response.forEach(product => {
    //           productSelect.append(`<option value="${product.ProductID}">${product.Name}</option>`);
    //         });
    //       },
    //       error: function(error) {
    //         Swal.fire('Error', 'Could not load products.', 'error');
    //       }
    //     });
    //   } catch {
    //     Swal.fire('Error', 'Error fetching products data.', 'error');
    //   }
    // }

    // L·∫•y danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o select
    async function fetchProducts() {
        try {
            const res = await $.ajax({
                url: 'http://localhost:3000/api/products', // ƒê·∫£m b·∫£o API n√†y tr·∫£ v·ªÅ danh s√°ch s·∫£n ph·∫©m
                method: 'GET',
                success: function(response) {
                    const productSelect = $('#editProductID, #addProductID');
                    productSelect.empty();  // X√≥a c√°c option c≈©
                    response.forEach(product => {
                        productSelect.append(`<option value="${product.ProductID}">${product.ProductName}</option>`);
                    });
                },
                error: function(error) {
                    Swal.fire('Error', 'Could not load products.', 'error');
                }
            });
        } catch {
            Swal.fire('Error', 'Error fetching products data.', 'error');
        }
    }

// M·ªü modal th√™m bi·∫øn th·ªÉ v√† ƒë·∫£m b·∫£o fetchProducts ch·∫°y xong tr∆∞·ªõc khi m·ªü modal
$('#addVariantBtn').click(async function() {
    await fetchProducts();  // ƒê·∫£m b·∫£o fetchProducts ch·∫°y xong
    $('#addVariantModal').modal('show');  // M·ªü modal sau khi d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i
});


    // 1. Hi·ªÉn th·ªã danh s√°ch bi·∫øn th·ªÉ
    async function fetchVariants(minPrice = 0, maxPrice = 9999999, productName = '') {
      try {
        const res = await $.ajax({
          url: `${API}`, // L·∫•y t·∫•t c·∫£ bi·∫øn th·ªÉ
          method: 'GET',
          success: function(response) {
            const table = $('#variantTable').DataTable({ destroy: true });
            table.clear();
            response.forEach(v => {
              if (v.Price >= minPrice && v.Price <= maxPrice && v.Name.toLowerCase().includes(productName.toLowerCase())) {
                table.row.add([
                  v.VariantID,
                  v.ProductID,
                  v.ProductName, // Hi·ªÉn th·ªã t√™n s·∫£n ph·∫©m
                  v.Name,
                  v.Price,
                  v.StockQuantity,
                  v.Attribute,
                  v.Value,
                  `<button class="btn btn-warning btn-sm me-1" onclick="editVariant(${v.VariantID})"><i class="fa fa-edit"></i></button>
                   <button class="btn btn-danger btn-sm" onclick="deleteVariant(${v.VariantID})"><i class="fa fa-trash"></i></button>`
                ]);
              }
            });
            table.draw();
          },
          error: function(error) {
            Swal.fire('Error', 'Could not load variants.', 'error');
          }
        });
      } catch {
        Swal.fire('Error', 'Error fetching variants data.', 'error');
      }
    }

    // M·ªü modal th√™m bi·∫øn th·ªÉ
    // $('#addVariantBtn').click(function() {
    //     fetchProducts(); // G·ªçi fetchProducts tr∆∞·ªõc khi m·ªü modal
    //   $('#addVariantModal').modal('show');
    // });

    $('#addVariantBtn').click(async function() {
        await fetchProducts();  // ƒê·∫£m b·∫£o fetchProducts ch·∫°y xong
        $('#addVariantModal').modal('show');  // M·ªü modal sau khi d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i
    });

    // 2. M·ªü modal v√† l·∫•y variant
    function editVariant(id) {
      $.ajax({
        url: `${API}/${id}`,
        method: 'GET',
        success: function(v) {
          $('#editVariantID').val(v.VariantID);
          $('#editProductID').val(v.ProductID);
          $('#editName').val(v.Name);
          $('#editPrice').val(v.Price);
          $('#editStockQuantity').val(v.StockQuantity);
          $('#editAttribute').val(v.Attribute);
          $('#editValue').val(v.Value);
          $('#updateModal').modal('show');
        },
        error: function(error) {
          Swal.fire('Error', 'Could not fetch variant data.', 'error');
        }
      });
    }

    // 3. X·ª≠ l√Ω submit th√™m bi·∫øn th·ªÉ
    $('#addVariantForm').on('submit', function(e) {
      e.preventDefault();
      const payload = {
        productID: $('#addProductID').val(),
        name: $('#addName').val(),
        price: $('#addPrice').val(),
        stockQuantity: $('#addStockQuantity').val(),
        attribute: $('#addAttribute').val(),
        value: $('#addValue').val()
      };
      $.ajax({
        url: `${API}/create`, // API ƒë·ªÉ th√™m m·ªõi bi·∫øn th·ªÉ
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
          Swal.fire('Success', 'Variant added successfully!', 'success');
          fetchVariants();
        },
        error: function(error) {
          Swal.fire('Error', 'Add variant failed!', 'error');
        }
      });
      $('#addVariantModal').modal('hide');
    });

    // 4. X√≥a variant
    function deleteVariant(id) {
      Swal.fire({
        title: 'Confirm',
        text: 'Are you sure you want to delete this variant?',
        icon: 'warning',
        showCancelButton: true
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: `${API}/delete`,  // X√≥a variant
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ variantID: id }),
            success: function(response) {
              Swal.fire('Deleted', 'Variant deleted successfully!', 'success');
              fetchVariants();
            },
            error: function(error) {
              Swal.fire('Error', 'Delete failed!', 'error');
            }
          });
        }
      });
    }

    // L·ªçc theo gi√°
    $('#filterPrice').click(function() {
      const minPrice = $('#priceMin').val() || 0;
      const maxPrice = $('#priceMax').val() || 9999999;
      fetchVariants(minPrice, maxPrice);
    });

    // L·ªçc theo t√™n s·∫£n ph·∫©m
    $('#filterProduct').click(function() {
      const productName = $('#productNameFilter').val();
      fetchVariants(0, 9999999, productName);
    });

    // G·ªçi h√†m fetchVariants ƒë·ªÉ t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu khi trang ƒë∆∞·ª£c load
    $(document).ready(function() {
      fetchVariants();
    });
    fetchProducts();
  </script>
</body>
</html>
